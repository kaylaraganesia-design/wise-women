<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiseWomen - Kalender Menstruasi</title>
    <!-- Tailwind CSS untuk styling cepat dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CUSTOM CSS --- */
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #eff6ff; /* Biru sangat muda */
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: 600;
            background: white;
            border: 1px solid #fce7f3;
        }

        .calendar-day:hover {
            background-color: #fbcfe8;
        }

        /* Hari ini */
        .calendar-day.today {
            border: 2px solid #1d4ed8; /* Biru tua */
            color: #1d4ed8;
        }

        /* Hari terpilih */
        .calendar-day.selected {
            background-color: #dbeafe; /* Biru muda */
            border: 2px solid #3b82f6; /* Biru */
        }

        /* Indikator Haid */
        .period-dot {
            width: 8px;
            height: 8px;
            background-color: #1d4ed8; /* Biru tua */
            border-radius: 50%;
            margin-top: 4px;
        }

        .period-active {
            background-color: #dbeafe; /* Biru background untuk hari haid */
            color: #1d4ed8;
        }
        
        .symptom-tag {
            transition: all 0.2s;
        }
        .symptom-checkbox:checked + .symptom-tag {
            background-color: #3b82f6; /* Biru */
            color: white;
            border-color: #3b82f6;
        }

        /* Logo Bulan Gradasi */
        .fa-moon.logo-gradasi {
            background: linear-gradient(to bottom, #1e40af, #60a5fa); /* Biru tua ke biru muda */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Sembunyikan scrollbar tapi tetap bisa scroll */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="text-gray-700 h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white shadow-sm p-4 z-10">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-moon text-2xl logo-gradasi"></i>
                <h1 class="text-2xl font-bold text-blue-700">WiseWomen</h1>
            </div>
            <button onclick="toggleView()" class="text-blue-600 font-semibold hover:bg-blue-50 px-3 py-1 rounded-lg transition">
                <i id="view-icon" class="fas fa-chart-bar mr-1"></i> <span id="view-text">Statistik</span>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT CONTAINER -->
    <main class="flex-1 overflow-y-auto relative max-w-md mx-auto w-full bg-white sm:shadow-xl sm:my-4 sm:rounded-xl">
        
        <!-- VIEW: KALENDER -->
        <div id="calendar-view" class="p-4 pb-24 animate-fade-in">
            <!-- Navigasi Bulan -->
            <div class="flex justify-between items-center mb-6">
                <button onclick="changeMonth(-1)" class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2 id="current-month-year" class="text-xl font-bold text-gray-800">November 2025</h2>
                <button onclick="changeMonth(1)" class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 hover:bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <!-- Grid Hari (Sen, Sel, Rab...) -->
            <div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-gray-400">
                <div>MGG</div>
                <div>SEN</div>
                <div>SEL</div>
                <div>RAB</div>
                <div>KAM</div>
                <div>JUM</div>
                <div>SAB</div>
            </div>

            <!-- Kalender -->
            <div id="calendar-grid" class="calendar-grid mb-6">
                <!-- Generated by JS -->
            </div>

            <!-- Detail Hari Terpilih (Hidden by default until clicked) -->
            <div id="day-details" class="bg-blue-50 rounded-xl p-5 hidden border border-blue-100">
                <div class="flex justify-between items-center mb-4 border-b border-blue-200 pb-2">
                    <h3 class="font-bold text-lg text-blue-800"><i class="far fa-calendar-alt mr-2"></i><span id="selected-date-text">Tanggal</span></h3>
                    <button onclick="closeDetails()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>

                <form id="entry-form" onsubmit="saveEntry(event)">
                    <!-- Intensitas -->
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Intensitas Menstruasi</label>
                        <div class="flex gap-2">
                            <label class="cursor-pointer flex-1">
                                <input type="radio" name="flow" value="0" class="peer sr-only" checked>
                                <div class="text-center p-2 rounded-lg border peer-checked:bg-white peer-checked:text-gray-500 text-gray-400 text-xs">Tidak Ada</div>
                            </label>
                            <label class="cursor-pointer flex-1">
                                <input type="radio" name="flow" value="1" class="peer sr-only">
                                <div class="text-center p-2 rounded-lg border border-blue-200 peer-checked:bg-blue-300 peer-checked:text-blue-900 text-gray-600 text-xs transition">Ringan</div>
                            </label>
                            <label class="cursor-pointer flex-1">
                                <input type="radio" name="flow" value="2" class="peer sr-only">
                                <div class="text-center p-2 rounded-lg border border-blue-300 peer-checked:bg-blue-500 peer-checked:text-white text-gray-600 text-xs transition">Sedang</div>
                            </label>
                            <label class="cursor-pointer flex-1">
                                <input type="radio" name="flow" value="3" class="peer sr-only">
                                <div class="text-center p-2 rounded-lg border border-blue-400 peer-checked:bg-blue-700 peer-checked:text-white text-gray-600 text-xs transition">Berat</div>
                            </label>
                        </div>
                    </div>

                    <!-- Gejala -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Gejala yang dirasakan</label>
                        <div class="flex flex-wrap gap-2" id="symptoms-container">
                            <!-- Checkboxes generated by JS -->
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition transform active:scale-95">
                        Simpan Catatan
                    </button>
                </form>
            </div>
            
            <!-- Hint jika belum pilih tanggal -->
            <div id="empty-state" class="text-center py-10 text-gray-400">
                <i class="fas fa-hand-pointer text-4xl mb-3 text-blue-200"></i>
                <p>Pilih tanggal di kalender untuk<br>mencatat siklus atau gejala.</p>
            </div>
        </div>

        <!-- VIEW: STATISTIK -->
        <div id="stats-view" class="hidden p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Analisis Siklusmu</h2>

            <!-- Kartu Rata-Rata -->
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-blue-100 p-4 rounded-2xl text-center">
                    <div class="text-sm text-gray-600 mb-1">Rata-rata Durasi</div>
                    <div class="text-3xl font-bold text-blue-700"><span id="avg-duration">-</span> <span class="text-sm font-normal">hari</span></div>
                    <div class="text-xs text-gray-500 mt-1">Lama Haid</div>
                </div>
                <div class="bg-purple-100 p-4 rounded-2xl text-center">
                    <div class="text-sm text-gray-600 mb-1">Rata-rata Siklus</div>
                    <div class="text-3xl font-bold text-purple-700"><span id="avg-cycle">-</span> <span class="text-sm font-normal">hari</span></div>
                    <div class="text-xs text-gray-500 mt-1">Jarak antar Haid</div>
                </div>
            </div>

            <!-- Gejala Terbanyak -->
            <div class="bg-white border border-gray-100 rounded-2xl p-5 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Gejala Paling Sering</h3>
                <div id="top-symptoms-list" class="space-y-3">
                    <!-- List generated by JS -->
                    <p class="text-gray-400 text-sm italic text-center">Belum ada data gejala yang cukup.</p>
                </div>
            </div>
            
            <div class="mt-6 bg-blue-50 p-4 rounded-xl text-xs text-blue-800 leading-relaxed">
                <i class="fas fa-info-circle mr-1"></i> <b>Catatan:</b> Statistik ini dihitung berdasarkan data yang kamu masukkan. Semakin rajin kamu mencatat, semakin akurat prediksinya.
            </div>
        </div>

    </main>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script>
        // --- DATA & CONFIG ---
        const symptomsList = [
            "Kram Perut", "Sakit Kepala", "Jerawat", "Nyeri Punggung", 
            "Lelah", "Mood Swing", "Kembung", "Nafsu Makan Naik", "Nyeri Payudara"
        ];
        
        let currentDate = new Date();
        let selectedDate = null;
        let entries = JSON.parse(localStorage.getItem('wiseWomenData')) || {}; // Format: { "YYYY-MM-DD": { flow: 1, symptoms: [] } }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderCalendar();
            renderSymptomsOptions();
            calculateStats();
        });

        // --- CALENDAR LOGIC ---
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update Header Bulan
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            document.getElementById('current-month-year').innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = "";

            // Padding days (kosong sebelum tanggal 1)
            for (let i = 0; i < firstDay; i++) {
                const emptyDiv = document.createElement('div');
                calendarGrid.appendChild(emptyDiv);
            }

            // Days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const el = document.createElement('div');
                el.className = 'calendar-day';
                el.innerText = day;
                
                // Highlight Hari Ini
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    el.classList.add('today');
                }

                // Cek jika ada data
                if (entries[dateStr]) {
                    if (entries[dateStr].flow > 0) {
                        el.classList.add('period-active'); // Background pink
                        const dot = document.createElement('div');
                        dot.className = 'period-dot';
                        el.appendChild(dot);
                    }
                }

                // Highlight Selected
                if (selectedDate === dateStr) {
                    el.classList.add('selected');
                }

                el.onclick = () => selectDate(dateStr);
                calendarGrid.appendChild(el);
            }
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }

        function selectDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar(); // Re-render untuk highlight
            
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('day-details').classList.remove('hidden');
            document.getElementById('selected-date-text').innerText = formatDateIndo(dateStr);

            // Load data existing jika ada
            const entry = entries[dateStr] || { flow: 0, symptoms: [] };
            
            // Set Radio Flow
            const radios = document.getElementsByName('flow');
            radios.forEach(r => {
                r.checked = (parseInt(r.value) === entry.flow);
            });

            // Set Checkboxes Symptoms
            const checkboxes = document.querySelectorAll('.symptom-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = entry.symptoms.includes(cb.value);
            });
        }

        function closeDetails() {
            document.getElementById('day-details').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            selectedDate = null;
            renderCalendar();
        }

        // --- FORM LOGIC ---
        function renderSymptomsOptions() {
            const container = document.getElementById('symptoms-container');
            symptomsList.forEach(sym => {
                const label = document.createElement('label');
                label.className = 'cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" value="${sym}" class="symptom-checkbox sr-only">
                    <div class="symptom-tag px-3 py-1 rounded-full border border-blue-200 text-xs text-gray-600 hover:bg-blue-50 select-none">${sym}</div>
                `;
                container.appendChild(label);
            });
        }

        function saveEntry(e) {
            e.preventDefault();
            if (!selectedDate) return;

            const flow = parseInt(document.querySelector('input[name="flow"]:checked').value);
            const symptoms = Array.from(document.querySelectorAll('.symptom-checkbox:checked')).map(cb => cb.value);

            if (flow === 0 && symptoms.length === 0) {
                delete entries[selectedDate]; // Hapus jika kosong
            } else {
                entries[selectedDate] = { flow, symptoms };
            }

            localStorage.setItem('wiseWomenData', JSON.stringify(entries));
            
            // Visual feedback
            const btn = e.target.querySelector('button');
            const originalText = btn.innerText;
            btn.innerText = "Tersimpan!";
            btn.classList.add('bg-green-500', 'hover:bg-green-600');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('bg-green-500', 'hover:bg-green-600');
                closeDetails(); // Tutup form
                renderCalendar(); // Update titik di kalender
                calculateStats(); // Update statistik
            }, 800);
        }

        // --- STATS LOGIC ---
        function calculateStats() {
            const dates = Object.keys(entries).sort();
            if (dates.length === 0) {
                updateStatsUI(0, 0, {});
                return;
            }

            // 1. Identifikasi Periode Haid (Group consecutive dates)
            let periods = [];
            let currentPeriod = [];

            dates.forEach((dateStr) => {
                if (entries[dateStr].flow > 0) { // Hanya hitung jika flow > 0 (haid)
                    const date = new Date(dateStr);
                    
                    if (currentPeriod.length === 0) {
                        currentPeriod.push(date);
                    } else {
                        const lastDate = currentPeriod[currentPeriod.length - 1];
                        const diffTime = Math.abs(date - lastDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

                        if (diffDays <= 2) { // Jika selisih <= 2 hari, dianggap satu periode
                            currentPeriod.push(date);
                        } else {
                            periods.push(currentPeriod);
                            currentPeriod = [date];
                        }
                    }
                }
            });
            if (currentPeriod.length > 0) periods.push(currentPeriod);

            // 2. Hitung Rata-rata Durasi (Lama Haid)
            let totalDuration = 0;
            periods.forEach(p => {
                // Durasi = (Last Day - First Day) + 1
                const dur = Math.ceil((p[p.length-1] - p[0]) / (1000 * 60 * 60 * 24)) + 1;
                totalDuration += dur;
            });
            const avgDuration = periods.length ? Math.round(totalDuration / periods.length) : 0;

            // 3. Hitung Rata-rata Siklus (Jarak Start ke Start berikutnya)
            let totalCycleDays = 0;
            let cycleCount = 0;
            for (let i = 0; i < periods.length - 1; i++) {
                const startA = periods[i][0];
                const startB = periods[i+1][0];
                const diff = Math.ceil((startB - startA) / (1000 * 60 * 60 * 24));
                // Filter outlier (misal siklus < 15 hari atau > 50 hari mungkin tidak valid/irregular)
                if(diff > 15 && diff < 60) { 
                    totalCycleDays += diff;
                    cycleCount++;
                }
            }
            const avgCycle = cycleCount ? Math.round(totalCycleDays / cycleCount) : 0;

            // 4. Hitung Gejala
            let symptomCounts = {};
            dates.forEach(d => {
                if (entries[d].symptoms) {
                    entries[d].symptoms.forEach(s => {
                        symptomCounts[s] = (symptomCounts[s] || 0) + 1;
                    });
                }
            });

            updateStatsUI(avgDuration, avgCycle, symptomCounts);
        }

        function updateStatsUI(duration, cycle, symptomCounts) {
            document.getElementById('avg-duration').innerText = duration || "-";
            document.getElementById('avg-cycle').innerText = cycle || "-";

            const sortedSymptoms = Object.entries(symptomCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3); // Top 3

            const listContainer = document.getElementById('top-symptoms-list');
            listContainer.innerHTML = "";

            if (sortedSymptoms.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-400 text-sm italic text-center">Belum ada data gejala.</p>`;
            } else {
                // Cari max value untuk progress bar
                const maxVal = sortedSymptoms[0][1];

                sortedSymptoms.forEach(([name, count]) => {
                    const percent = (count / maxVal) * 100;
                    listContainer.innerHTML += `
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-medium text-gray-700">${name}</span>
                                <span class="text-gray-500 text-xs">${count}x</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    `;
                });
            }
        }

        // --- UTILS ---
        function toggleView() {
            const cal = document.getElementById('calendar-view');
            const stats = document.getElementById('stats-view');
            const icon = document.getElementById('view-icon');
            const text = document.getElementById('view-text');

            if (cal.classList.contains('hidden')) {
                cal.classList.remove('hidden');
                stats.classList.add('hidden');
                icon.className = "fas fa-chart-bar mr-1";
                text.innerText = "Statistik";
            } else {
                cal.classList.add('hidden');
                stats.classList.remove('hidden');
                calculateStats(); // Refresh stats saat dibuka
                icon.className = "fas fa-calendar-alt mr-1";
                text.innerText = "Kalender";
            }
        }

        function formatDateIndo(dateStr) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateStr).toLocaleDateString('id-ID', options);
        }
    </script>
</body>
</html>
